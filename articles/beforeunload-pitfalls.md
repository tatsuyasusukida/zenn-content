---
title: "[WIP] Next.js ã§ beforeunload ã‚’ä½¿ã†éš›ã®è½ã¨ã—ç©´"
emoji: "ğŸ•³"
type: "tech"
topics: ["javascript", "typescript", "nextjs", "react"]
published: false
publication_name: "collabostyle"
---

## ã“ã®è¨˜äº‹ã«ã¤ã„ã¦

ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã®ã‚ã‚‹ Web ã‚¢ãƒ—ãƒªã§ãƒ•ã‚©ãƒ¼ãƒ å†…å®¹ã®å¤‰æ›´å¾Œã€ãƒšãƒ¼ã‚¸ç§»å‹•ã‚„ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹å‰ã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå ´åˆã«ã¯ window ã® beforeunload ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ©ç”¨ã§ãã¾ã™ãŒã€Next.js ã‚¢ãƒ—ãƒªã§å®Ÿè£…ã—ã‚ˆã†ã¨ã—ãŸã¨ã“ã‚æ„å¤–ã¨è½ã¨ã—ç©´ãŒå¤šãã¦è‹¦åŠ´ã—ã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã§ã¯å®Ÿè£…ã®éç¨‹ã§å¾—ã‚‰ã‚ŒãŸçŸ¥è¦‹ã‚’ã¾ã¨ã‚ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

## beforeunload ã‚¤ãƒ™ãƒ³ãƒˆ

MDN ã®èª¬æ˜ãŒã‚ã‹ã‚Šã‚„ã™ã„ã®ã§å¼•ç”¨ã—ã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/API/Window/beforeunload_event

> beforeunload ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã€æ–‡æ›¸ã€ãŠã‚ˆã³ãã®ãƒªã‚½ãƒ¼ã‚¹ãŒã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ç›´å‰ã«ç™ºç”Ÿã—ã¾ã™ã€‚

> ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã£ã¦ã€ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ãŒãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒšãƒ¼ã‚¸ã‚’çµ‚äº†ã™ã‚‹ã‹ã©ã†ã‹ã®ç¢ºèªãŒæ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’ä¸‹è¨˜ã«ç¤ºã—ã¾ã™ã€‚

```js:ã‚³ãƒ¼ãƒ‰ä¾‹
window.addEventListener('beforeunload', (event) => {
  event.preventDefault();
  return (event.returnValue = '');
});
```

ã¡ãªã¿ã«ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã¯è‹±èªç‰ˆãƒšãƒ¼ã‚¸ã®æ–¹ã«æ›¸ã„ã¦ã‚ã‚‹ã‚‚ã®ã§ã™ã€‚

https://developer.mozilla.org/en-US/docs/Web/API/Window/beforeunload_event

## Next.js ã§ã®å®Ÿè£…æ–¹æ³•

App Router ã‚’ä½¿ç”¨ã—ã¦å®Ÿè£…ã™ã‚‹å ´åˆã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’ä¸‹è¨˜ã«ç¤ºã—ã¾ã™ã€‚

```tsx:src/app/page.tsx
"use client";

import { useEffect } from "react";

export default function Home() {
  useEffect(() => {
    const listener = (event: BeforeUnloadEvent) => {
      event.preventDefault();
      return (event.returnValue = "");
    };

    window.addEventListener("beforeunload", listener);

    return () => {
      window.removeEventListener("beforeunload", listener);
    };
  }, []);

  return (
    <main className="container mx-auto">
      <h1 className="mt-4 mb-4 text-2xl">
        Next.js ã§ beforeunload ã‚’ä½¿ã†éš›ã®è½ã¨ã—ç©´
      </h1>
      <p className="mb-4">
        ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ãƒšãƒ¼ã‚¸ç§»å‹•ã‚„ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹æ™‚ã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      </p>
    </main>
  );
}
```

## è½ã¨ã—ç©´

åƒ•ãŒãƒãƒã£ãŸè½ã¨ã—ç©´ã¯ä¸‹è¨˜ã® 3 ã¤ã§ã™ã€‚

- ã‚¯ãƒªãƒƒã‚¯ã‹ã‚­ãƒ¼ã‚¿ã‚¤ãƒ—ãŒå¿…è¦
- event.returnValue = '' ãŒå¿…è¦
- useRef() ãŒå¿…è¦

ä»¥ä¸‹ã€ãã‚Œãã‚Œã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

### ã‚¯ãƒªãƒƒã‚¯ã‹ã‚­ãƒ¼ã‚¿ã‚¤ãƒ—ãŒå¿…è¦

ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã«ã¯ãƒšãƒ¼ã‚¸å†…ã§å°‘ãªãã¨ã‚‚ 1 å›ã¯ã‚¯ãƒªãƒƒã‚¯ã‹ã‚­ãƒ¼ã‚¿ã‚¤ãƒ—ãŒå¿…è¦ãªã‚ˆã†ã§ã™ã€‚ã“ã®ã“ã¨ã‚’çŸ¥ã‚‰ãªã‹ã£ãŸã®ã§ãƒªãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’é€£æ‰“ã—ã¦ã€Œãªã‚“ã§ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªã„ã‚“ã ã‚ã†ï¼Ÿã€ã¨æ‚©ã‚“ã§ã—ã¾ã„ã¾ã—ãŸã€‚

æ™®æ®µã¯ Mac ã® Google Chrome ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€Firefox ã¨ Safari ã§ã‚‚è©¦ã—ã¦ã¿ãŸã¨ã“ã‚åŒã˜çµæœãŒå¾—ã‚‰ã‚ŒãŸã®ã§å¤šãã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å…±é€šã®ä»•æ§˜ãªã®ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ã€‚

### event.returnValue = '' ãŒå¿…è¦

beforeunload ã«é–¢ã™ã‚‹ MDN ã®ãƒšãƒ¼ã‚¸ã«ã¯ä¸‹è¨˜ã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚

> ã—ã‹ã—ã€ã™ã¹ã¦ã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ãŒã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªãã€ä¸€éƒ¨ã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«å¤ã„æ–¹æ³•äºŒã¤ã®ã†ã¡ã®ä¸€ã¤ã‚’å®Ÿè£…ã™ã‚‹ã‚ˆã†æ±‚ã‚ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
>
> - ã‚¤ãƒ™ãƒ³ãƒˆã® returnValue ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«æ–‡å­—åˆ—ã‚’ä»£å…¥ã™ã‚‹
> - ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‹ã‚‰æ–‡å­—åˆ—ã‚’è¿”ã™

ã“ã®ã‚ˆã†ã«æ›¸ã„ã¦ã‚ã‚‹ã®ã§ `event.returnValue = ""` ã®ä»£ã‚ã‚Šã« `return ""` ã§ã‚‚è‰¯ã„ã®ã ã‚ã†ã¨æ€ã£ã¦ç½®ãæ›ãˆãŸã¨ã“ã‚ Google Chrome ã§ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã—ãŸã€‚

### useRef() ãŒå¿…è¦

### ãƒ¡ãƒ¢

```sh:ã‚³ãƒãƒ³ãƒ‰
npx create-next-app \
  --typescript \
  --tailwind \
  --eslint \
  --app \
  --src-dir \
  --import-alias "@/\*" \
  --use-npm \
  beforeunload-pitfalls
cd beforeunload-pitfalls
```
