---
title: "LINE 公式アカウントの友だち一覧を出力する方法"
emoji: "🤝"
type: "tech"
topics: ["typescript", "line", "api"]
published: false
---

## この記事について

最近、仕事で LINE ボットを開発しているのですがセットアップのために既存 LINE 公式アカウントから友だち一覧を出力する必要があり、この作業になかなか苦戦しました。この記事ではその過程で得られた知見をまとめたいと思います。

### GitHub リポジトリ

この記事の成果物は下記のリポジトリで公開しており、MIT ライセンスで利用可能です。

https://github.com/tatsuyasusukida/line-friend-export-v2

プログラミング言語には TypeScript を使用し、ソースコードはコメントも含めて全体で 400 行くらいになりました。TypeScript を利用した理由については単に使い慣れているという 1 点のみであり、HTTP リクエストが送信できる言語であれば何でも大丈夫です。

### Zenn スクラップ

この記事のベースは下記のスクラップです。

https://zenn.dev/tatsuyasusukida/scraps/ab9bf2326b4fce

この記事で不足している情報などがありましたら適宜参照していただければ幸いです。

## ユーザーの呼称

説明の便宜上、この記事では LINE 公式アカウントを運用するユーザーを「店舗」と呼び、LINE 公式アカウントを友だち登録するユーザーを「顧客」と呼ぶことにします。

## やりたいこと

やりたいことは下記の 2 つの情報を含む一覧を出力することです。

- 顧客ユーザー ID
- 顧客の本名

### 顧客ユーザー ID

ユーザー ID とはユーザーの一意な識別子であり、ユーザーの表示名や友だち検索に使用する LINE ID とは異なります。ユーザー ID は正規表現 `U[0-9a-f]{32}` にマッチする文字列で、例えば `U12345678901234567890123456789012` のような値になります。ユーザー ID については LINE Developers 公式ドキュメントにも記載があります。

https://developers.line.biz/ja/docs/messaging-api/getting-user-ids/#what-is-user-id

ユーザー ID については 1 つだけ注意する点があります。それは、**同じユーザーであってもプロバイダーごとに異なる値が発行される**点です。例えば下記 3 つのケースを考えた場合、成功するのはケース 1 だけです。

- ⭕️ ケース 1：同じプロバイダーに含まれるチャネル C1 と C2 があり、C1 からエクスポートした顧客ユーザー ID を C2 で利用する。
- ❌ ケース 2：あるプロバイダー P1 からエクスポートした顧客ユーザー ID を別のプロバイダー P2 で利用する。
- ❌ ケース 3：ある LINE 公式アカウント A1 からエクスポートした顧客ユーザー ID を別の LINE 公式アカウント A2 で利用する。

プロバイダーとは LINE 公式アカウントを通じてサービスを提供する店舗や企業のことであり、Messaging API などを利用する時に作成する必要があるものです。LINE 公式アカウントとプロバイダーの間には 1 対多の関係があり、プロバイダーとチャネルの間には 1 対多の関係があります。

**既存 LINE 公式アカウントからエクスポートしたユーザー ID を新規に作成する LINE 公式アカウントで利用したいと考えている方は要注意です。**

### 顧客の本名

LINE で顧客が設定した名前は「表示名」と呼ばれます。表示名として本名を設定している方もいますが、それ以外の名前を設定している方も多く、本名で設定していたとしても苗字だけやファーストネームだけのケースもあります。

LINE から提供される情報だけでは顧客が誰かを判断することができないので何らかの手段で本人確認を行う必要があります。本人確認に ID 連携が利用できれば店舗側は手間が少ないのですが、そのようなシステムがない場合はややアナログですがチャットで氏名・住所・生年月日などを確認することになるのではないかと思います。

本人確認が完了した後は「この顧客は ●● さんである」という情報をどこかに保存しておく必要があります。この保存先としてよく使われそうなのが LINE Official Account Manager（管理画面）のチャットページです。このチャットページには「表示名を変更」という機能があり、顧客の本名などを保存することができます。

このように店舗側が設定した表示名は LINE のシステム的には「nickname（ニックネーム）」と呼ばれるようです。ニックネームに本名を保存することになるのでやや紛らわしいですね。

## 使用する API

やりたいことを実現するために LINE が提供する下記 3 つの API を使用します。

- LINE 公式アカウントを友だち追加したユーザーのリストを取得する API
- ユーザー ID からプロフィール情報を取得する API
- チャットページからトークできる友だちのリストを取得する API（非公式）

上記のままだとやや長いなのでそれぞれ下記のように呼ぶことにします。

- ユーザー ID 一覧 API
- プロフィール詳細 API
- チャット一覧 API（非公式）

### ユーザー ID 一覧 API

LINE 公式アカウントを友だち追加したユーザーのリストを取得するには下記の HTTP リクエストを送信します。

```
GET https://api.line.me/v2/bot/followers/ids
```

HTTP リクエストの詳細については公式ドキュメントがとてもわかりやすいので説明を割愛します。

https://developers.line.biz/ja/reference/messaging-api/#get-follower-ids

1 点だけ注意が必要なのは、この API を利用できるのは「認証済アカウント」または「プレミアムアカウント」のみである点です。認証済アカウントについては下記ページが詳しいです。

https://www.linebiz.com/jp/service/line-official-account/verified-account/

### プロフィール詳細 API

ユーザー ID からプロフィール情報を取得するには下記の HTTP リクエストを送信します。

```
GET https://api.line.me/v2/bot/profile/{userId}
```

こちらも公式ドキュメントがとてもわかりやすいので説明を割愛します。

https://developers.line.biz/ja/reference/messaging-api/#get-profile

### チャット一覧 API（非公式）
